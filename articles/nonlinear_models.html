<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nonlinear models in flocker • flocker</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Nonlinear models in flocker">
<meta property="og:description" content="flocker">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flocker</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/augmented_models.html">Data-augmented models in flocker</a>
    </li>
    <li>
      <a href="../articles/flocker_tutorial.html">Fitting occupancy models with flocker</a>
    </li>
    <li>
      <a href="../articles/multiseason_models.html">Multiseason models in flocker</a>
    </li>
    <li>
      <a href="../articles/nonlinear_models.html">Nonlinear models in flocker</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jsocolar/flocker/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Nonlinear models in flocker</h1>
                        <h4 data-toc-skip class="author">Jacob
Socolar</h4>
            
            <h4 data-toc-skip class="date">2023-10-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jsocolar/flocker/blob/HEAD/vignettes/nonlinear_models.Rmd" class="external-link"><code>vignettes/nonlinear_models.Rmd</code></a></small>
      <div class="hidden name"><code>nonlinear_models.Rmd</code></div>

    </div>

    
    
<p><img align="right" src="../reference/figures/flocker_sticker.png" width="30%"></p>
<p>Here we show how we can use <code>flocker</code> to fit nonlinear
occupancy models via <code>brms</code>. In most occupancy models,
occupancy and detection probabilties are modeled as logit-linear
combinations of covariates. In some models (e.g. those with splines or
Gaussian processes), probabilities are modeled as the sum of more
flexibile functions of covariates. These are straightforward to fit in
<code>flocker</code> using the <code>brms</code> functions
<code><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">s()</a></code>, <code><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">t2()</a></code>, and <code><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">gp()</a></code>; see the <a href="https://jsocolar.github.io/flocker/articles/flocker_tutorial.html" class="external-link">flocker
tutorial vignette</a> for details.</p>
<p>This vignette focuses on more complicated nonlinear models that
require the use of special nonlinear <code>brms</code> formulas. We
showcase two models. The first fits a parameteric nonlinear predictor.
The second fits a model with a spatially varying coefficient that is
given a gaussian process prior.</p>
<div class="section level2">
<h2 id="parameteric-nonlinear-predictor">Parameteric nonlinear predictor<a class="anchor" aria-label="anchor" href="#parameteric-nonlinear-predictor"></a>
</h2>
<p>In this scenario, we consider a model where the response is a
specific nonlinear parametric function whose parameters are fitted and
might or might not depend on covariates. Suppose for example that an
expanding population of a territorial species undergoes logistic growth,
and also that some unknown proportion of territories are unsuitable due
to an unobserved factor, such that occupancy asymptotes at some
probability less than one. Thus, occupancy probability changes through
time as <span class="math inline">\(\frac{L}{1 +
e^{-k(t-t_0)}}\)</span>, where <span class="math inline">\(L\)</span> is
the asymptote, <span class="math inline">\(k\)</span> is a growth rate,
<span class="math inline">\(t\)</span> is time, and <span class="math inline">\(t_0\)</span> is the timing of the inflection
point. At multiple discrete times, we randomly sample several sites to
survey, and survey each of those sites over several repeat visits.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jsocolar/flocker" class="external-link">flocker</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">.1</span></span>
<span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">5</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">15</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n_site_per_time</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">n_visit</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">det_prob</span> <span class="op">&lt;-</span> <span class="fl">.3</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">n_site_per_time</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">psi</span> <span class="op">&lt;-</span> <span class="va">L</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span><span class="op">*</span><span class="op">(</span><span class="va">t</span> <span class="op">-</span> <span class="va">t0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">data</span><span class="op">$</span><span class="va">psi</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">det_prob</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">v2</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">det_prob</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">v3</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">det_prob</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"v1"</span>, <span class="st">"v2"</span>, <span class="st">"v3"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  unit_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>t <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"t"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="va">event_covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dummy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_visit</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We wish to fit an occupancy model that recovers the unknown
parameters <span class="math inline">\(L\)</span>, <span class="math inline">\(k\)</span>, and <span class="math inline">\(t_0\)</span>. We can achieve this using the
nonlinear formula syntax provided by <code>brms</code> via
<code>flocker</code>.</p>
<p><code>flocker</code> will always assume that the occupancy formula is
provided on the logit scale. Thus, we need to convert our nonlinear
function giving the occupancy probability to a function giving the logit
occupancy probability. A bit of simplification via Wolfram Alpha and we
arrive at <span class="math inline">\(\log(\frac{L}{1 + e^{-k(t - t_0)}
- L})\)</span>. We then write a <code>brms</code> formula representing
occupancy via this function. To specify a formula wherein a
distributional parameter (<code>occ</code> in this case, referring to
occupancy) is nonlinear we need to use <code><a href="https://paul-buerkner.github.io/brms/reference/brmsformula-helpers.html" class="external-link">brms::set_nl()</a></code>
rather than merely providing the <code>nl = TRUE</code> argument to
<code><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">brms::bf()</a></code>.</p>
<p><code>flocker</code>’s main fitting function <code><a href="../reference/flock.html">flock()</a></code>
accepts <code>brmsformula</code> inputs to its <code>f_det</code>
argument. When supplying a <code>brmsformula</code> to
<code>f_det</code> (rather than the typical one-sided detection
formula), the following behaviors are triggered:</p>
<ul>
<li><p>Several input checks are turned off. For example,
<code>flocker</code> no longer checks to ensure that event covariates
are absent from the occupancy formula. <code>flocker</code> also no
longer explicitly checks that formulas are provided for all of the
required distributional terms for a given family (detection, occupancy,
colonization, extinction, and autologistic terms, depending on the
family).</p></li>
<li><p>All inputs to <code>f_occ</code>, <code>f_col</code>,
<code>f_ex</code>, <code>f_auto</code> are silently ignored. It is
obligatory to pass the entire formula for all distributional parameters
as a single <code>brmsformula</code> object. This means in turn that the
user must be familiar with <code>flocker</code>’s internal naming
conventions for all of the relevant distributional parameters
(<code>det</code> and one or more of <code>occ</code>,
<code>colo</code>, <code>ex</code>, <code>autologistic</code>,
<code>Omega</code>). If fitting a data-augmented model, it will be
requried to pass the <code>Omega ~ 1</code> formula within the
<code>brmsformula</code> (When passing the traditional one-sided formula
to <code>f_det</code>, <code>flocker</code> includes the formula for
<code>Omega</code> internally and automatically).</p></li>
<li><p>Nonlinear formulas that involve data that are required to be
positive might fail! Internally, some irrelevant data positions get
filled with <code>-99</code>, but these positions might still get
evaluated by the nonlinear formula, even though they make no
contribution to the likelihood.</p></li>
</ul>
<p>With all of that said, we can go ahead and fit this model!</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span>f_det <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>                 <span class="va">det</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">dummy</span>,</span>
<span>                 <span class="va">occ</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span><span class="op">*</span><span class="op">(</span><span class="va">t</span> <span class="op">-</span> <span class="va">t0</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 <span class="va">L</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 <span class="va">k</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 <span class="va">t0</span> <span class="op">~</span> <span class="fl">1</span></span>
<span>               <span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula-helpers.html" class="external-link">set_nl</a></span><span class="op">(</span>dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span>,</span>
<span>             prior <span class="op">=</span> </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                 <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"t0"</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"L"</span>, lb <span class="op">=</span> <span class="fl">0</span>, ub <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>                <span class="op">)</span>,</span>
<span>             flocker_data <span class="op">=</span> <span class="va">fd</span>, </span>
<span>             control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>             cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.9 may help.</span></span>
<span><span class="co">#&gt; See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt;  Family: occupancy_single </span></span>
<span><span class="co">#&gt;   Links: mu = identity; occ = identity </span></span>
<span><span class="co">#&gt; Formula: ff_y | vint(ff_n_unit, ff_n_rep, ff_Q, ff_rep_index1, ff_rep_index2, ff_rep_index3) ~ 1 + dummy </span></span>
<span><span class="co">#&gt;          occ ~ log(L/(1 + exp(-k * (t - t0)) - L))</span></span>
<span><span class="co">#&gt;          L ~ 1</span></span>
<span><span class="co">#&gt;          k ~ 1</span></span>
<span><span class="co">#&gt;          t0 ~ 1</span></span>
<span><span class="co">#&gt;    Data: data (Number of observations: 2790) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept       -0.90      0.13    -1.16    -0.66 1.00     2294     2302</span></span>
<span><span class="co">#&gt; L_Intercept      0.50      0.10     0.37     0.75 1.00     1221      977</span></span>
<span><span class="co">#&gt; k_Intercept      0.19      0.08     0.07     0.37 1.00     1200     1719</span></span>
<span><span class="co">#&gt; t0_Intercept    -5.90      3.41   -10.41     3.03 1.00     1223     1078</span></span>
<span><span class="co">#&gt; dummy           -0.00      0.08    -0.15     0.15 1.00     2752     2526</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>It works!</p>
<p>Note that if desired, we could fit more complicated formulas than
<code>~ 1</code> for any of the nonlinear parameters. For more see the
<a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_nonlinear.html" class="external-link">brms
nonlinear model vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="spatially-varying-coefficients-via-a-gaussian-process">Spatially varying coefficients via a Gaussian process<a class="anchor" aria-label="anchor" href="#spatially-varying-coefficients-via-a-gaussian-process"></a>
</h2>
<p>The <code><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">gp()</a></code> function in <code>brms</code> includes a
Gaussian process of arbitary dimension in the linear predictor. We can
use the nonlinear formula syntax to tell <code>brms</code> to include a
Gaussian process prior on a coefficient as well.</p>
<p>First we simulate some data wherein the logit of the occupancy
probability depends on a covariate, and the slope of the dependency is
modeled via a two-dimensional spatial Gaussian process:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span> <span class="co"># sample size</span></span>
<span><span class="va">lscale</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="co"># square root of l of the gaussian kernel</span></span>
<span><span class="va">sigma_gp</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># sigma of the gaussian kernel</span></span>
<span><span class="va">intercept</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># occupancy logit-intercept</span></span>
<span><span class="va">det_intercept</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="co"># detection logit-intercept</span></span>
<span><span class="va">n_visit</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span></span>
<span><span class="co"># covariate data for the model</span></span>
<span><span class="va">gp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># get distance matrix</span></span>
<span><span class="va">dist.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">gp_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># get covariance matrix</span></span>
<span><span class="va">cov.mat</span> <span class="op">&lt;-</span> <span class="va">sigma_gp</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="op">(</span><span class="va">dist.mat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">lscale</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate occupancy data</span></span>
<span><span class="va">gp_data</span><span class="op">$</span><span class="va">coef</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/rmvn.html" class="external-link">rmvn</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span>, <span class="va">cov.mat</span><span class="op">)</span></span>
<span><span class="va">gp_data</span><span class="op">$</span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">intercept</span> <span class="op">+</span> <span class="va">gp_data</span><span class="op">$</span><span class="va">coef</span> <span class="op">*</span> <span class="va">gp_data</span><span class="op">$</span><span class="va">covariate</span></span>
<span><span class="va">gp_data</span><span class="op">$</span><span class="va">psi</span> <span class="op">&lt;-</span> <span class="fu">boot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/inv.logit.html" class="external-link">inv.logit</a></span><span class="op">(</span><span class="va">gp_data</span><span class="op">$</span><span class="va">lp</span><span class="op">)</span></span>
<span><span class="va">gp_data</span><span class="op">$</span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">gp_data</span><span class="op">$</span><span class="va">psi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate visit data</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">n_visit</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_visit</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">obs</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">gp_data</span><span class="op">$</span><span class="va">Z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu">boot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/inv.logit.html" class="external-link">inv.logit</a></span><span class="op">(</span><span class="va">det_intercept</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And here’s how we can fit this model in <code>flocker</code>! It
turns out that we need quite a lot of data points to constrain the
standard deviation of the Gaussian process, and so we use a Hilbert
space approximate Gaussian process for computational efficiency.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, unit_covs <span class="op">=</span> <span class="va">gp_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"covariate"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">svc_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_det <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>                 <span class="va">det</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 <span class="va">occ</span> <span class="op">~</span> <span class="va">occint</span> <span class="op">+</span> <span class="va">g</span> <span class="op">*</span> <span class="va">covariate</span>,</span>
<span>                 <span class="va">occint</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 <span class="va">g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">gp</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, k <span class="op">=</span> <span class="fl">20</span>, c <span class="op">=</span> <span class="fl">1.25</span><span class="op">)</span></span>
<span>               <span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula-helpers.html" class="external-link">set_nl</a></span><span class="op">(</span>dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd2</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">svc_mod</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: occupancy_single_C </span></span>
<span><span class="co">#&gt;   Links: mu = identity; occ = identity </span></span>
<span><span class="co">#&gt; Formula: ff_n_suc | vint(ff_n_trial) ~ 1 </span></span>
<span><span class="co">#&gt;          occ ~ occint + g * covariate</span></span>
<span><span class="co">#&gt;          occint ~ 1</span></span>
<span><span class="co">#&gt;          g ~ 0 + gp(x, y, scale = FALSE, k = 20, c = 1.25)</span></span>
<span><span class="co">#&gt;    Data: data (Number of observations: 2000) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gaussian Process Terms: </span></span>
<span><span class="co">#&gt;                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sdgp(g_gpxy)       1.69      0.78     0.73     3.67 1.00     3368     3076</span></span>
<span><span class="co">#&gt; lscale(g_gpxy)     0.23      0.11     0.08     0.50 1.00     4128     3128</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept           -1.04      0.06    -1.15    -0.93 1.00     6089     2975</span></span>
<span><span class="co">#&gt; occint_Intercept     0.09      0.09    -0.08     0.27 1.00     6221     3132</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>Again, it worked!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jacob B. Socolar, Simon C. Mills.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
